language: rust
sudo: required
dist: trusty
rust: nightly

matrix:
  include:
    - os: linux
      env: TARGETS=x86_64-unknown-linux-musl
      before_install:
        - sudo apt-get install -y --no-install-recommends make libc6-dev curl
        - curl https://www.musl-libc.org/releases/musl-1.1.16.tar.gz | tar xzf -
        - sudo mkdir /musl-x86_64 && sudo chown $USER:$USER /musl-x86_64
        - cd musl-1.1.16 && ./configure --prefix=/musl-x86_64 \
          && make install -j4 && cd ..
        - rm -rf musl-1.1.16
        - export PATH=$PATH:/musl-x86_64/bin
      install:
        - rustup target add x86_64-unknown-linux-musl
      script:
        - cargo test --verbose
    - os: linux
      env: TARGETS=i686-unknown-linux-musl
      before_install:
        - sudo apt-get install -y --no-install-recommends gcc-multilib make libc6-dev curl
        - curl https://www.musl-libc.org/releases/musl-1.1.16.tar.gz | tar xzf -
        - sudo mkdir /musl-i686 && sudo chown $USER:$USER /musl-i686
        - cd musl-1.1.16 \
          && CC=gcc CFLAGS=-m32 ./configure --prefix=/musl-i686 --disable-shared --target=i686 \
          && make CROSS_COMPILE= install -j4 && cd ..
        - rm -rf musl-1.1.16
        - export PATH=$PATH:/musl-i686/bin
      install:
        - rustup target add i686-unknown-linux-musl
      script:
        - cargo test --verbose
